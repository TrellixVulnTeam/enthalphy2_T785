WRKDIR=`pwd`
export WRKDIR
#
paramlist="$*"
# default extensions
OUTEXT="out"
DALEXT="dal"
MOLEXT="mol"
AUXEXT="MOL NCA ORB IRC TRJ CM HES MOPUN WLK"
#deafult values for options
opta=0
optA=0
optd=0
optD=1
optf=
optF=0
optn=0
optlam=
opti=0
opto=0
optstex=0
optvib=0
opthes=0
optloc=0
optI=0
optv=0
optw=0
frl=rel
#
# Define usage message
#
usage (){
	  echo
	  echo "Usage:    lsdalton [-b directory] [-d] [-D] [-ext log | -o file] [-f] [-m mem | -M mem]"
	  echo  "[-N nodes] [-lam file] [-o file] [-t directory] [-w directory] dal{.$DALEXT} mol{.$MOLEXT}"
	  echo
	  echo 'Options:'
	  echo ' -b dir    change directory where basis sets are searched for to dir'
	  echo ' -d        delete TMPDIR before calculation starts'
	  echo ' -D        do not delete TMPDIR after calculation stops'
	  echo ' -ext log  change output extension from ".out" to ".log"'
	  echo ' -o FILE   redirect output from program to FILE in WRKDIR'
	  echo ' -f FILE   extract content of FILE.tar.gz from WRKDIR in TMPDIR before calculation starts'
	  echo ' -m mem    set scratch memory to mem Mwords'
	  echo ' -M mem    set scratch memory to mem Mb'
	  echo ' -N num    use MPI version with num nodes'
	  echo ' -lam file call "lamboot file" and "wipe file" before and after mpirun'
	  echo ' -t dir    change TMPDIR from default to dir'
	  echo ' -w dir    change WRKDIR from default to dir'
	  echo
	 }
#
# Define backup function
#
backup () {
  if [ "$1" = "-v" ]; then ekko=1; shift
  else ekko=0;
  fi
  for i in $* ; do
     if [ -f "${i}" ]; then
        for j in 6 5 4 3 2 1 0 ; do
           jp=`expr $j + 1`
           if [ -f "${i}.${j}" ]; then 
              [ $ekko -eq 1 ] && echo "Backup: renaming ${i}.${j} to ${i}.${jp}"
              mv -f "${i}.${j}" "${i}.${jp}"
           fi
        done
        if [ $ekko -eq 1 ]; then echo "Backup: renaming ${i} to ${i}.0"; fi
        mv -f "${i}" "${i}.0"
     fi
  done
}
#
# Interpret input
#
while [ -n "`echo $1 | grep '^-'`" ]; do
    case $1 in
      -b ) BASDIR="$2"; export BASDIR; shift;;
      -d ) optd=1;;
      -D ) optD=0;;
      -ext ) OUTEXT=$2; shift;;
      -f ) optf="$2"; shift;;
      -N ) optn=$2; shift;;
      -lam* ) optlam=$2; shift;;
      -m ) WRKMEM=$2; export WRKMEM; shift;;
      -M ) WRKMEM=`expr $2 "*" 128000`; export WRKMEM; shift;;
      -o ) OUTFIL=$2; export OUTFIL; opto=1; shift;;
      -t ) TMPDIR=$2; shift;;
      -w ) WRKDIR="`pwd`/$2"; shift;;
      * ) usage; exit 1;;
   esac
   shift
done
# check for correct input
if [ -z "$1" ]; then
   echo 'Input file[s] not specified'
   usage
   exit 1
fi
if [ -z "$2" ]; then
#  remove .mol, if added by user
   molfil=`basename $1 .mol`
   dalfil=$molfil
   outnam=$molfil
else
#  remove .mol and .dal, if added by user
   molfil=`basename $2 .mol`
   dalfil=`basename $1 .dal`
   if [ "$molfil" = "$dalfil" ]; then
      outnam=$molfil
   else
      outnam=${dalfil}_${molfil}
   fi
fi
#
export TMPDIR
#
echo
echo "   ******************************************* "
echo "   **** OUTPUT FROM LSDALTON SHELL SCRIPT **** "
echo "   ****        Release 2011               **** "
echo "   ******************************************* "
echo; echo "   Invocation: $0 $paramlist"
echo; echo "   `date`"
echo;
echo "   Calculation: $outnam  (input files: $dalfil and $molfil)"
echo "   PID        : $$"
echo "   Input dir  : $WRKDIR"
echo "   Scratch dir: $TMPDIR/$outnam"
#echo "  Work memory: $WRKMEM"
echo;
#
if [ ! -d "$TMPDIR" ]; then
   mkdir -p $TMPDIR
fi

SCRATCHDIR=$TMPDIR/$2;

if [ -d "$TMPDIR" -a -w "$TMPDIR" ]; then
   if [ $optd -eq 1 ] ; then
      rm -rf $TMPDIR/$outnam
   fi
   if [ ! -d "$TMPDIR/$outnam" ]; then
      mkdir -p $TMPDIR/$outnam
   fi
   cd $TMPDIR/$outnam
   if [ -s $WRKDIR/$dalfil.$DALEXT -a -r $WRKDIR/$dalfil.$DALEXT ]; then
      cp $WRKDIR/$dalfil.$DALEXT DALTON.INP
   else
      echo "$WRKDIR/$dalfil.$DALEXT does not exist or is not readable"
      exit 1
   fi
   if [ -s $WRKDIR/$molfil.$MOLEXT -a -r $WRKDIR/$molfil.$MOLEXT ]; then
      cp $WRKDIR/$molfil.$MOLEXT MOLECULE.INP
   else
      echo "$WRKDIR/$molfil.$MOLEXT does not exist or is not readable"
      echo "===> assuming single-input file calculation."
      cp $WRKDIR/$dalfil.$DALEXT MOLECULE.INP
   fi
   if [ "$optf" != "" ] ; then
      if [ -s $WRKDIR/$optf.tar.gz -a -r $WRKDIR/$optf.tar.gz ] ; then
         echo "Unpacking restart files..."
	 gunzip < $WRKDIR/$optf.tar.gz | tar xvf -
      else
	 echo "$WRKDIR/$optf.tar.gz does not exist or is not readable"
	 exit 1
      fi
   fi
else
   echo "$TMPDIR does not exist or is not writeable"
   exit 1
fi
#
if [ $optn -gt 1 ] ; then
   if [ -s $MPIRUN -a -x $MPIRUN ]; then
      if [ -a $DALMPI -a -x $DALMPI ]; then
	 if [ -n $optlam ] ; then
	    lamboot -v  $WRKDIR/$optlam
	    $MPIRUN -np $optn $DALMPI
	    wipe    -v  $WRKDIR/$optlam
	 else
	    $MPIRUN -np $optn $DALMPI
	 fi
      else
	 echo "$DALMPI does not exist or is not executeable"
	 exit 1
      fi
   else
      echo "$MPIRUN does not exist or is not executeable"
      exit 1
   fi
else
   if [ -s $LSDALTON -a -x $LSDALTON ]; then
      $LSDALTON
      lsdalton_exitcode=$?
   else
      echo; echo  "FATAL ERROR:"
      echo "$LSDALTON does not exist or is not executeable"
      exit 1
   fi
fi

if [ $lsdalton_exitcode -ne 0 ] ; then
   echo; echo  "SERIOUS ERROR:"
   echo "LSDALTON finished with non-zero exit code: $lsdalton_exitcode"
   echo; echo "File list in scratch directory:";echo
   ls -lt
   du -h
fi

filelist="LSDALTON.ERR SIRIUS.RST RESULTS.RSP RSPVEC SIRIFC DALTON.NCA UNIT1 UNIT2 DALTON.MOL DALTON.ORB DALTON.IRC DALTON.BAS DALTON.TRJ DALTON.CM DALTON.HES DALTON.MOPUN DALTON.WLK molden.inp dens.restart"

for i in $filelist ; do
   if [ -s $i -a -r $i ] ; then
      tarfilelist=$tarfilelist" "$i
   fi
done

if [ -s "first.wrl" -a -r "first.wrl" ] ; then
   tar cf - $tarfilelist *wrl | gzip -9 > $outnam.tar.gz
else
   tar cf - $tarfilelist | gzip -9 > $outnam.tar.gz
fi

if [ -s $outnam.tar.gz ] ; then
   backup -v $WRKDIR/$outnam.tar.gz 
   cp $outnam.tar.gz $WRKDIR
   echo "$outnam.tar.gz has been copied to $WRKDIR"
else
    echo "$outnam.tar.gz has not been created and has thus not been copied to $WRKDIR"
fi

   if [ $opto -eq 1 ] ; then
      if [ -s $WRKDIR/$OUTFIL -a -r $WRKDIR/$OUTFIL ]; then
         echo "Output is in $WRKDIR/$OUTFIL as requested in input."
      else
         echo "$WRKDIR/$OUTFIL has not been created from the present run"
         if [ $optD -eq 1 ] ; then
            echo "$TMPDIR/$outnam is therefore not deleted by this script."
         fi
         exit 2
      fi
   else
      backup -v $WRKDIR/$outnam.$OUTEXT
      if [ -s LSDALTON.OUT -a -r LSDALTON.OUT ]; then
         cp LSDALTON.OUT $WRKDIR/$outnam.$OUTEXT
         [ -f newLSDALTON.OUT ] && cp -f newLSDALTON.OUT $WRKDIR/$outnam.new.$OUTEXT
      else
         echo "LSDALTON.OUT has not been created from the present run."
         if [ $optD -eq 1 ] ; then
            echo "$TMPDIR/$outnam is therefore not deleted by this script."
         fi
         echo "List of created files in $TMPDIR/$outnam :"
         ls -sltr
         exit 2
      fi
   fi
cd $WRKDIR
if [ $optD -eq 1 ] ; then
   rm -rf $TMPDIR/$outnam
fi

exit $lsdalton_exitcode

# end of LSDALTON job script
